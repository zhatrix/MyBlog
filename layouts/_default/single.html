{{ define "main" }}
<div class="container" role="main">
  <div class="row">
    <!-- 文章目录 (TOC) - 左侧悬浮 -->
    {{ if .TableOfContents }}
      {{ if gt (len .TableOfContents) 100 }}
      <aside id="toc-sidebar" class="toc-sidebar">
        <div class="toc-wrapper">
          <h4 class="toc-title">文章目录</h4>
          <nav id="TableOfContents">
            {{ .TableOfContents }}
          </nav>
        </div>
      </aside>
      {{ end }}
    {{ end }}

    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
      <article role="main" class="blog-post">
        {{ .Content }}

        {{ if .Params.tags }}
          <div class="blog-tags">
            {{ range .Params.tags }}
              <!-- Fix for "https://github.com/halogenica/beautifulhugo/issues/349".
              Inspired by "https://github.com/dovidio/personalwebsite/commit/34762e94c29fd2c26c16c45f8ae2de21bdf9b46d".
              <a href="{{ $.Site.LanguagePrefix | absURL }}/tags/{{ . | urlize }}/">{{ . }}</a>&nbsp;
              -->
              <a href="{{"tags" | absLangURL}}/{{ . | urlize }}/">{{ . }}</a>&nbsp;
            {{ end }}
          </div>
        {{ end }}

        {{ if $.Param "socialShare" }}
            <hr/>
            <section id="social-share">
              <div class="list-inline footer-links">
                {{ partial "share-links" . }}
              </div>
            </section>
        {{ end }}

        {{ if .Site.Params.showRelatedPosts }}
          {{ range first 1 (where (where .Site.Pages ".Params.tags" "intersect" .Params.tags) "Permalink" "!=" .Permalink) }}
            {{ $.Scratch.Set "has_related" true }}
          {{ end }}

          {{ if $.Scratch.Get "has_related" }}
                  <h4 class="see-also">{{ i18n "seeAlso" }}</h4>
                  <ul>
                {{ $num_to_show := .Site.Params.related_content_limit | default 5 }}
                {{ range first $num_to_show (where (where .Site.Pages ".Params.tags" "intersect" .Params.tags) "Permalink" "!=" .Permalink) }}
                    <li><a href="{{ .RelPermalink }}">{{ .Title }}</a></li>
                {{ end }}
              </ul>

          {{ end }}
        {{ end }}
      </article>

      {{ if ne .Type "page" }}
        <ul class="pager blog-pager">
          {{ if .PrevInSection }}
            <li class="previous">
              <a href="{{ .PrevInSection.Permalink }}" data-toggle="tooltip" data-placement="top" title="{{ .PrevInSection.Title }}">&larr; {{ i18n "previousPost" }}</a>
            </li>
          {{ end }}
          {{ if .NextInSection }}
            <li class="next">
              <a href="{{ .NextInSection.Permalink }}" data-toggle="tooltip" data-placement="top" title="{{ .NextInSection.Title }}">{{ i18n "nextPost" }} &rarr;</a>
            </li>
          {{ end }}
        </ul>
      {{ end }}


      {{ if (.Params.comments) | or (and (or (not (isset .Params "comments")) (eq .Params.comments nil)) (and .Site.Params.comments (ne .Type "page"))) }}
      
      {{ if .Site.Params.cusdisID }}

        <div id="cusdis_thread"
          data-host="https://cusdis.com"
          data-app-id="{{ .Site.Params.cusdisID }}"
          data-page-id="{{ .Permalink }}"
          data-page-url="{{ .Permalink }}"
          data-page-title="{{ .Title }}"
          data-theme="auto"
        ></div>
        <script async defer src="https://cusdis.com/js/cusdis.es.js"></script>

      {{ end }}
      
      {{ if .Site.Config.Services.Disqus.Shortname }}
          {{ if .Site.Params.delayDisqus }}
          <div class="disqus-comments">                  
            <button id="show-comments" class="btn btn-default" type="button">{{ i18n "show" }} <span class="disqus-comment-count" data-disqus-url="{{ trim .Permalink "/" }}">{{ i18n "comments" }}</span></button>
            <div id="disqus_thread"></div>

            <script type="text/javascript">
              var disqus_config = function () {
              this.page.url = '{{ trim .Permalink "/" }}';
            };

          </script>
          </div>
          {{ else }}
          <div class="disqus-comments">
            {{ partial "disqus-wrapper.html" . }}
          </div>
          {{ end }}
        {{ end }}
        {{ if .Site.Params.staticman }}
          <div class="staticman-comments">
            {{ partial "staticman-comments.html" . }}
          </div>
        {{ end }}
      {{ end }}

    </div>
  </div>
</div>

<style>
/* 文章目录样式 */
.toc-sidebar {
  position: fixed;
  left: 0;
  top: 120px;
  max-width: 280px;
  max-height: calc(100vh - 140px);
  padding: 0 20px 0 40px;
  overflow-y: auto;
  z-index: 100;
}

.toc-wrapper {
  background: #fff;
  border: 1px solid #e0e0e0;
  border-radius: 8px;
  padding: 20px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.toc-title {
  margin: 0 0 15px 0;
  padding-bottom: 10px;
  border-bottom: 2px solid #008AFF;
  color: #404040;
  font-size: 16px;
  font-weight: 600;
}

#TableOfContents {
  font-size: 14px;
  line-height: 1.8;
}

#TableOfContents ul {
  list-style: none;
  padding-left: 0;
  margin: 0;
}

#TableOfContents > ul > li {
  margin-bottom: 8px;
}

#TableOfContents ul ul {
  padding-left: 15px;
  margin-top: 5px;
}

#TableOfContents li {
  margin-bottom: 5px;
}

#TableOfContents a {
  color: #666;
  text-decoration: none;
  display: block;
  padding: 3px 8px;
  border-left: 2px solid transparent;
  transition: all 0.3s ease;
}

#TableOfContents a:hover {
  color: #008AFF;
  background-color: #f5f5f5;
  border-left-color: #008AFF;
}

#TableOfContents a.active {
  color: #008AFF;
  font-weight: 600;
  border-left-color: #008AFF;
  background-color: #f0f8ff;
}

/* 滚动条样式 */
.toc-sidebar::-webkit-scrollbar {
  width: 6px;
}

.toc-sidebar::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 3px;
}

.toc-sidebar::-webkit-scrollbar-thumb {
  background: #ccc;
  border-radius: 3px;
}

.toc-sidebar::-webkit-scrollbar-thumb:hover {
  background: #999;
}

/* 响应式设计 - 在中等屏幕及以下隐藏 TOC */
@media only screen and (max-width: 1400px) {
  .toc-sidebar {
    display: none;
  }
}

/* 在大屏幕上调整内容区域，为 TOC 留出空间 */
@media only screen and (min-width: 1400px) {
  .container {
    max-width: 1200px;
  }
}
</style>

<script>
// 文章目录高亮当前阅读位置
document.addEventListener('DOMContentLoaded', function() {
  const toc = document.getElementById('TableOfContents');
  if (!toc) return;

  const links = toc.querySelectorAll('a');
  const headings = [];

  // 收集所有标题元素
  links.forEach(link => {
    const id = link.getAttribute('href').substring(1);
    const heading = document.getElementById(id);
    if (heading) {
      headings.push({ link, heading });
    }
  });

  // 监听滚动事件
  let ticking = false;
  window.addEventListener('scroll', function() {
    if (!ticking) {
      window.requestAnimationFrame(function() {
        updateActiveLink();
        ticking = false;
      });
      ticking = true;
    }
  });

  function updateActiveLink() {
    const scrollPosition = window.scrollY + 100;

    let currentHeading = null;
    headings.forEach(({ link, heading }) => {
      const headingTop = heading.offsetTop;
      if (scrollPosition >= headingTop) {
        currentHeading = link;
      }
    });

    links.forEach(link => link.classList.remove('active'));
    if (currentHeading) {
      currentHeading.classList.add('active');
    }
  }

  // 初始化
  updateActiveLink();

  // 平滑滚动
  links.forEach(link => {
    link.addEventListener('click', function(e) {
      e.preventDefault();
      const id = this.getAttribute('href').substring(1);
      const target = document.getElementById(id);
      if (target) {
        window.scrollTo({
          top: target.offsetTop - 80,
          behavior: 'smooth'
        });
      }
    });
  });
});
</script>

{{ end }}
